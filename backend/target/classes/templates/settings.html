<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Settings - My Home</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="">
    <!-- Wrapper for Centered Content -->
    <div class="main-content-wrapper">
        <div class="header">
            <h1>Settings</h1>
        </div>

        <div class="card"
            style="aspect-ratio: auto; min-height: auto; flex-direction: row; align-items: center; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div
                    style="background: #007AFF; width: 32px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                    <svg style="width: 20px; height: 20px; color: white;" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3C7.03 3 3 7.03 3 12C3 16.97 7.03 21 12 21C16.97 21 21 16.97 21 12C21 7.03 16.97 3 12 3M12 19C8.13 19 5 15.87 5 12C5 8.13 8.13 5 12 5C15.87 5 19 8.13 19 12C19 15.87 15.87 19 12 19M12 7V17M12 7L7 12M12 7L17 12" />
                    </svg>
                </div>
                <span style="font-size: 17px; font-weight: 500;">Dark Mode</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Display Settings -->
        <div th:if="${!userRole.contains('GUEST')}">
            <h3 style="margin: 20px 0 10px; color: var(--text-muted); font-size: 14px; text-transform: uppercase;">
                Display
            </h3>

            <div class="card" style="aspect-ratio: auto; min-height: auto; flex-direction: column; padding: 0;">
                <!-- Live Power Toggle -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--divider-color);">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div
                            style="background: #34C759; width: 32px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                            <svg style="width: 20px; height: 20px; color: white;" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path d="M13 2L3 14H12V22L22 10H13V2Z" />
                            </svg>
                        </div>
                        <span style="font-size: 17px; font-weight: 500;">Live Power Bar</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="livePowerToggle"
                            onchange="toggleSetting('showLivePower', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Chart Toggle -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div
                            style="background: #FF9500; width: 32px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                            <svg style="width: 20px; height: 20px; color: white;" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M9 17H7V10H9V17M13 17H11V7H13V17M17 17H15V13H17V17Z" />
                            </svg>
                        </div>
                        <span style="font-size: 17px; font-weight: 500;">Daily Usage Chart</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="chartToggle"
                            onchange="toggleSetting('showDailyChart', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Settings -->
    <div th:if="${!userRole.contains('GUEST')}">
        <h3 style="margin: 20px 0 10px; color: var(--text-muted); font-size: 14px; text-transform: uppercase;">Security
        </h3>
        <div class="card" style="aspect-ratio: auto; min-height: auto; flex-direction: column; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="background: #5856D6; width: 32px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                        <svg style="width: 20px; height: 20px; color: white;" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                        </svg>
                    </div>
                    <span style="font-size: 17px; font-weight: 500;">Two-Factor Auth</span>
                </div>
                <!-- Status Text -->
                <div id="2faStatus" style="font-size: 15px; color: var(--text-muted);">Disabled</div>
            </div>

            <!-- Expansion for Setup -->
            <div id="2faSetup"
                style="display: none; margin-top: 20px; border-top: 1px solid var(--divider-color); padding-top: 20px;">
                <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">Scan with Microsoft
                    Authenticator
                </p>

                <!-- QR Code Container (White BG for scanning) -->
                <div id="qrcode"
                    style="width: 170px; height: 170px; margin: 0 auto 20px; background: white; padding: 10px; border-radius: 8px;">
                </div>

                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">Or enter code manually:</p>
                <code id="manualKey"
                    style="display: block; margin-bottom: 20px; font-family: monospace; font-size: 16px; color: var(--text-color); background: var(--bg-color); padding: 8px; border-radius: 6px; user-select: all;">Loading...</code>

                <input type="text" id="verifyCode" class="input-field" placeholder="Enter 6-digit code"
                    style="text-align: center; margin-bottom: 10px;">
                <button onclick="enable2FA()" class="btn-primary" style="margin-top: 0; padding: 12px;">Enable</button>
            </div>

            <button id="setupBtn" onclick="startSetup()" class="btn-primary"
                style="margin-top: 16px; background: #E5E5EA; color: #007AFF;">Setup 2FA</button>
            <button id="disableBtn" onclick="disable2FA()" class="btn-primary"
                style="margin-top: 16px; background: #FF3B30; color: white; display: none;">Disable 2FA</button>
        </div>

        <h3 style="margin: 20px 0 10px; color: var(--text-muted); font-size: 14px; text-transform: uppercase;">Recovery
            Options
        </h3>
        <div class="card" style="aspect-ratio: auto; min-height: auto; flex-direction: column; padding: 20px;">
            <div style="display: flex; flex-direction: column; gap: 16px; width: 100%;">
                <div>
                    <label style="font-size: 15px; font-weight: 500; display: block; margin-bottom: 8px;">Mobile
                        Number</label>
                    <input type="tel" id="recoveryMobile" placeholder="+91 99999 99999" class="input-field"
                        style="width: 100%; border: 1px solid var(--divider-color); padding: 10px; border-radius: 8px;">
                </div>
                <div>
                    <label style="font-size: 15px; font-weight: 500; display: block; margin-bottom: 8px;">Recovery
                        Email</label>
                    <input type="email" id="recoveryEmail" placeholder="backup@example.com" class="input-field"
                        style="width: 100%; border: 1px solid var(--divider-color); padding: 10px; border-radius: 8px;">
                </div>
                <button onclick="saveRecoveryOptions()" class="btn-primary"
                    style="margin-top: 10px; padding: 12px;">Save Recovery Options</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Bottom Navigation Dock -->
    <div class="dock-container">
        <a href="/home" class="dock-item">
            <svg class="dock-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
            </svg>
            <span class="dock-label">Home</span>
        </a>

        <!-- Usage Link (Hidden for GUEST) -->
        <a th:if="${!userRole.contains('GUEST')}" href="/usage" class="dock-item">
            <svg class="dock-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M16 6L18.29 8.29L13.41 13.17L9.41 9.17L2 16.59L3.41 18L9.41 12L13.41 16L19.71 9.71L22 12V6H16Z" />
            </svg>
            <span class="dock-label">Usage</span>
        </a>

        <!-- Settings Link (Active) -->
        <a href="/settings" class="dock-item active">
            <svg class="dock-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
            </svg>
            <span class="dock-label">Settings</span>
        </a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let secretKey = '';

        async function checkStatus() {
            try {
                const res = await fetch('/api/auth/2fa/status');
                if (res.ok) {
                    const data = await res.json();
                    if (data.enabled) {
                        document.getElementById('2faStatus').innerText = 'Enabled';
                        document.getElementById('2faStatus').style.color = '#34C759';
                        document.getElementById('setupBtn').style.display = 'none';
                        document.getElementById('disableBtn').style.display = 'block';
                        document.getElementById('2faSetup').style.display = 'none';
                    } else {
                        document.getElementById('2faStatus').innerText = 'Disabled';
                        document.getElementById('2faStatus').style.color = 'var(--text-muted)';
                        document.getElementById('setupBtn').style.display = 'block';
                        document.getElementById('disableBtn').style.display = 'none';
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function startSetup() {
            document.getElementById('2faSetup').style.display = 'block';
            document.getElementById('setupBtn').style.display = 'none';

            try {
                const res = await fetch('/api/auth/2fa/generate', { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    secretKey = data.secret;

                    // Show Manual Key
                    document.getElementById('manualKey').innerText = secretKey;

                    // Render QR
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById('qrcode'), {
                        text: data.otpAuthUrl,
                        width: 150,
                        height: 150
                    });
                } else {
                    alert("Failed to generate key");
                }
            } catch (e) {
                console.error(e);
                alert("Error connecting to server");
            }
        }

        async function enable2FA() {
            const code = document.getElementById('verifyCode').value.trim();

            if (!code || code.length < 6) {
                alert("Please enter the 6-digit code from your app");
                return;
            }

            const res = await fetch('/api/auth/2fa/enable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code, secret: secretKey })
            });

            if (res.ok) {
                alert('2FA Enabled Successfully');
                checkStatus();
            } else {
                const msg = await res.text();
                alert('Verification Failed: ' + msg);
            }
        }

        async function disable2FA() {
            if (!confirm('Disable 2FA?')) return;
            const res = await fetch('/api/auth/2fa/disable', { method: 'POST' });
            if (res.ok) {
                checkStatus();
            }
        }

        async function saveRecoveryOptions() {
            const mobile = document.getElementById('recoveryMobile').value;
            const email = document.getElementById('recoveryEmail').value;

            try {
                const res = await fetch('/api/recovery/options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobile: mobile, recoveryEmail: email })
                });

                if (res.ok) {
                    alert('Recovery options saved successfully!');
                } else {
                    alert('Failed to save options.');
                }
            } catch (e) { console.error(e); }
        }

        async function loadRecoveryOptions() {
            try {
                const res = await fetch('/api/recovery/options');
                if (res.ok) {
                    const data = await res.json();
                    if (data.mobile) document.getElementById('recoveryMobile').value = data.mobile;
                    if (data.recoveryEmail) document.getElementById('recoveryEmail').value = data.recoveryEmail;
                }
            } catch (e) { console.error(e); }
        }

        checkStatus();
        loadRecoveryOptions();

        // Check for saved theme
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme) {
            document.documentElement.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'dark') {
                document.getElementById('themeToggle').checked = true;
            }
        }

        // Init other settings
        if (localStorage.getItem('showLivePower') !== 'false') { // Default True if not set
            document.getElementById('livePowerToggle').checked = true;
        } else {
            document.getElementById('livePowerToggle').checked = false;
        }

        if (localStorage.getItem('showDailyChart') !== 'false') { // Default True
            document.getElementById('chartToggle').checked = true;
        } else {
            document.getElementById('chartToggle').checked = false;
        }

        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            if (toggle.checked) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleSetting(key, isChecked) {
            localStorage.setItem(key, isChecked);
        }
    </script>
</body>

</html>