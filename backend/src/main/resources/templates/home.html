<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>AI Smart Home Energy Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script th:inline="javascript">
        // Inject user Role from Model
        const userRole = /*[[${userRole}]]*/ 'ROLE_USER';
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gray-800': '#1f2937',
                        'gray-900': '#111827',
                        'cyan-500': '#06b6d4',
                        'cyan-600': '#0891b2',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for device list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 antialiased min-h-screen font-sans">

    <div class="min-h-screen bg-gray-900 font-sans">
        <!-- Header -->
        <header class="bg-gray-800/50 backdrop-blur-sm shadow-lg sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                        </svg>
                        <h1 class="text-xl font-bold ml-3 text-gray-100">AI Smart Home Energy Manager</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="openModal()"
                            class="bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium py-2 px-4 rounded transition">Add
                            Device</button>

                        <!-- Developer Toggle (Admin Only) -->
                        <div id="devToggleContainer"
                            class="hidden items-center space-x-2 bg-gray-700 px-3 py-1 rounded">
                            <span class="text-xs text-yellow-400 font-mono">DEV MODE</span>
                            <button onclick="toggleDevMode()" id="devToggleBtn"
                                class="relative inline-flex h-5 w-9 items-center rounded-full bg-gray-600 transition-colors focus:outline-none">
                                <span class="sr-only">Enable Dev Mode</span>
                                <span id="devToggleKnob"
                                    class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform translate-x-1"></span>
                            </button>
                        </div>

                        <form action="/logout" method="post">
                            <button type="submit" class="text-sm text-gray-400 hover:text-white">Logout</button>
                        </form>
                    </div>
                </div>
            </div>
        </header>

        <!-- ADD DEVICE MODAL -->
        <div id="addDeviceModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">

                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
                    onclick="closeModal()"></div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                <div
                    class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">Add New Device
                                </h3>
                                <div class="mt-2">

                                    <!-- TABS -->
                                    <div class="flex border-b border-gray-700 mb-4">
                                        <button onclick="switchTab('manual')" id="tab-manual"
                                            class="flex-1 py-2 px-4 text-cyan-500 border-b-2 border-cyan-500 font-medium focus:outline-none">Manual
                                            Code</button>
                                        <button onclick="switchTab('qr')" id="tab-qr"
                                            class="flex-1 py-2 px-4 text-gray-400 font-medium hover:text-cyan-500 focus:outline-none">QR
                                            Scan</button>
                                        <button onclick="switchTab('discovery')" id="tab-discovery"
                                            class="flex-1 py-2 px-4 text-gray-400 font-medium hover:text-cyan-500 focus:outline-none">Discovery</button>
                                    </div>

                                    <!-- TAB CONTENT: MANUAL -->
                                    <div id="content-manual" class="space-y-4">
                                        <p class="text-sm text-gray-400">Enter the pairing string (Format:
                                            TYPE|NAME|POWER_WATTS|TOPIC|CRITICAL)</p>
                                        <input type="text" id="manualCodeInput"
                                            class="w-full bg-gray-700 text-white rounded px-3 py-2 border border-gray-600 focus:outline-none focus:border-cyan-500"
                                            placeholder="e.g. FAN|Office Fan|60">
                                        <button onclick="submitManualCode()"
                                            class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded">Add
                                            Device</button>
                                    </div>

                                    <!-- TAB CONTENT: QR -->
                                    <div id="content-qr" class="hidden space-y-4 text-center">
                                        <div
                                            class="h-48 bg-black rounded flex items-center justify-center border border-gray-700 relative overflow-hidden">
                                            <div id="qrScanner"
                                                class="absolute inset-0 flex items-center justify-center text-gray-500">
                                                [ Camera Feed Simulated ]
                                            </div>
                                            <div id="qrOverlay"
                                                class="absolute inset-0 border-2 border-cyan-500 opacity-50 hidden">
                                            </div>
                                        </div>
                                        <button onclick="simulateQrScan()"
                                            class="bg-gray-700 hover:bg-gray-600 text-white py-1 px-3 rounded text-sm mb-2">Simulate
                                            Camera Scan</button>
                                        <input type="hidden" id="qrCodeInput">
                                        <p id="qrResult" class="text-green-400 text-sm h-6"></p>
                                        <button onclick="submitQrCode()" id="qrSubmitBtn"
                                            class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded disabled:opacity-50"
                                            disabled>Confirm & Add</button>
                                    </div>

                                    <!-- TAB CONTENT: DISCOVERY -->
                                    <div id="content-discovery" class="hidden space-y-4">
                                        <div class="flex justify-between items-center">
                                            <p class="text-sm text-gray-400">Scanning for devices on local network...
                                            </p>
                                            <button onclick="scanNetwork()"
                                                class="text-cyan-400 hover:text-cyan-300 text-sm">Rescan</button>
                                        </div>
                                        <div id="discoveryList"
                                            class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar bg-gray-900/50 p-2 rounded">
                                            <!-- Discovered Items -->
                                            <p class="text-gray-500 text-center text-sm py-4">Click Rescan to find
                                                devices.</p>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" onclick="closeModal()"
                            class="w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <main>
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

                <div class="space-y-8">
                    <!-- Metric Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Live Power -->
                        <div
                            class="bg-gray-800 rounded-xl shadow-lg p-6 flex items-center space-x-4 transform hover:scale-105 transition-transform duration-300">
                            <div class="bg-cyan-500/20 p-3 rounded-full">
                                <svg class="h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Live Power</p>
                                <p class="text-2xl font-bold" id="totalPower">0 W</p>
                            </div>
                        </div>

                        <!-- Estimated Cost -->
                        <div
                            class="bg-gray-800 rounded-xl shadow-lg p-6 flex items-center space-x-4 transform hover:scale-105 transition-transform duration-300">
                            <div class="bg-green-500/20 p-3 rounded-full">
                                <svg class="h-8 w-8 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 11.21 12.77 10.5 12 10.5s-1.536.71-2.121 1.5c-.586.79-.586 1.804 0 2.594l.879.659z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Estimated Cost Today</p>
                                <p class="text-2xl font-bold" id="todayCost">₹0.00</p>
                            </div>
                        </div>

                        <!-- Active Devices -->
                        <div
                            class="bg-gray-800 rounded-xl shadow-lg p-6 flex items-center space-x-4 transform hover:scale-105 transition-transform duration-300">
                            <div class="bg-purple-500/20 p-3 rounded-full">
                                <svg class="h-8 w-8 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Active Devices</p>
                                <p class="text-2xl font-bold" id="activeDevices">0 / 0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Devices List -->
                        <div class="lg:col-span-1 bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-xl font-semibold mb-4">Devices</h2>
                            <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar" id="deviceList">
                                <!-- Devices will be injected here -->
                            </div>
                        </div>

                        <!-- Analytics & Recommendations -->
                        <div class="lg:col-span-2 space-y-8">
                            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                                <h2 class="text-xl font-semibold mb-4">Live Energy Usage (kW)</h2>
                                <!-- Chart Container -->
                                <div class="w-full h-48 md:h-64" id="chartContainer">
                                    <svg id="energyChart" class="w-full h-full" preserveAspectRatio="none"
                                        viewBox="0 0 300 100">
                                        <defs>
                                            <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                                <stop offset="0%" style="stop-color: #0891b2; stop-opacity: 0.4" />
                                                <stop offset="100%" style="stop-color: #0891b2; stop-opacity: 0" />
                                            </linearGradient>
                                        </defs>
                                        <path id="areaPath" d="" fill="url(#gradient)" />
                                        <path id="linePath" d="" fill="none" stroke="#06b6d4" stroke-width="1.5" />
                                    </svg>
                                </div>
                            </div>

                            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                                <h2 class="text-xl font-semibold mb-2">AI-Powered Recommendation</h2>
                                <div
                                    class="flex items-start space-x-4 text-yellow-300/90 bg-yellow-500/10 p-4 rounded-lg">
                                    <svg class="h-6 w-6 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.5 5.5a.5.5 0 01.5.5v5a.5.5 0 01-1 0v-5a.5.5 0 01.5-.5zM9 12.75a1 1 0 112 0 1 1 0 01-2 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    <p id="recommendationText">Analyzing usage patterns...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <footer class="bg-gray-800/30 mt-12 pb-16">
            <div class="container mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-gray-400 text-sm">
                <p>&copy; 2024 Smart Home Energy Manager. All rights reserved.</p>
            </div>
        </footer>

        <!-- DEVELOPER CONSOLE (Fixed Bottom) -->
        <div id="devConsole"
            class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 shadow-2xl transform translate-y-full transition-transform duration-300 z-40 hidden">
            <div class="flex items-center justify-between px-4 py-2 bg-gray-800 border-b border-gray-700 cursor-pointer"
                onclick="toggleDevConsoleHeight()">
                <div class="flex items-center space-x-2 text-yellow-500">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                    </svg>
                    <span class="font-mono text-sm font-bold">DEVELOPER CONSOLE</span>
                </div>
                <div class="flex text-xs text-gray-500 space-x-4">
                    <span>Role: <span class="text-white" th:text="${userRole}">USER</span></span>
                    <span class="text-cyan-500">Connected</span>
                    <button onclick="toggleDevMode()" class="hover:text-white">&times;</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-0 h-64 font-mono text-xs">
                <!-- Log Panel -->
                <div class="border-r border-gray-700 p-2 overflow-y-auto bg-black text-green-500">
                    <p class="text-gray-500 mb-2">// System Logs</p>
                    <div id="sysLogs" class="space-y-1">
                        <p>[INFO] System Initialized</p>
                    </div>
                </div>
                <!-- Interactive & Data -->
                <div class="flex flex-col bg-gray-800">
                    <div class="flex-1 p-2 overflow-y-auto text-cyan-300">
                        <p class="text-gray-500 mb-2">// Selected Device JSON</p>
                        <pre id="jsonViewer">{}</pre>
                    </div>
                    <div class="p-2 border-t border-gray-700 bg-gray-900 flex">
                        <span class="text-yellow-500 mr-2">$</span>
                        <input type="text"
                            class="flex-1 bg-transparent border-none focus:outline-none text-white font-mono"
                            placeholder="exec command..." onkeydown="handleConsoleCmd(event)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data & State ---
        const energyHistory = [];
        const maxHistoryPoints = 30;
        let isDevMode = false;
        const systemLogs = ["[INFO] System Initialized"];

        // Add Thymeleaf namespace fix for pure HTML view fallback
        /*<![CDATA[*/
        // userRole is defined at top
        /*]]>*/

        // If userRole is Admin, show toggle
        if (typeof userRole !== 'undefined' && userRole === 'ROLE_ADMIN') {
            document.getElementById('devToggleContainer').classList.remove('hidden');
            document.getElementById('devToggleContainer').classList.add('flex');
        }

        // --- Icons ---
        const icons = {
            LIGHT: "M12 18v-1.5m0 0a6 6 0 01-6-6v-.75a6 6 0 0112 0v.75a6 6 0 01-6 6zM12 1.5v3.75m0 16.5v1.5m-7.5-3h-1.5m16.5 0h1.5M4.53 4.53l1.06 1.06m0 12.82l-1.06 1.06m13.78 0l1.06-1.06M19.47 5.59l-1.06-1.06M9 20.25h6",
            AC: "M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25",
            FRIDGE: "M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3", // Approximation
            HEATER: "M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z",
            OTHER: "M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            updateMetrics();
            setInterval(loadDevices, 5000); // Refresh every 5s
            setInterval(updateMetrics, 2000); // Real-time power updates
        });

        async function loadDevices() {
            try {
                const res = await fetch('/api/devices');
                if (res.ok) {
                    const devices = await res.json();
                    renderDevices(devices);
                    updateActiveCount(devices);
                }
            } catch (e) { console.error(e); }
        }

        async function updateMetrics() {
            try {
                // Fetch live power metric (simulated/real)
                // Ideally we sum up device power, or fetch from /api/energy/summary
                const res = await fetch('/api/energy/summary');
                if (res.ok) {
                    const data = await res.json();

                    // Update Total Power
                    // data.usage is kWh (cumulative), let's pretend we have instantaneous Watts or derive it.
                    // For this demo, let's use the random variation in data.usage to animate "Live Power" or just fetch Devices sum.

                    // Let's sum device power from the list we have?
                    // Actually /api/energy/summary returns {usage: X, cost: Y}

                    // Update Cost
                    document.getElementById('todayCost').textContent = '₹' + data.cost.toFixed(2);

                    // Simulate Live Power based on usage or random flux for UI effect
                    const simulatedWatts = Math.round(data.usage * 1000 / 24); // Rough avg watts
                    document.getElementById('totalPower').textContent = simulatedWatts + ' W';

                    // Update Chart
                    updateChart(simulatedWatts / 1000.0); // convert to kW for chart

                    // Update Recommendations based on data
                    updateRecommendation(data.usage);
                }
            } catch (e) { console.error(e); }
        }

        async function toggleDevice(id) {
            log(`CMD: Toggle Device ID ${id}`);
            try {
                await fetch(`/api/devices/${id}/status`, { method: 'PUT' });
                loadDevices();
            } catch (e) {
                log(`ERR: Failed to toggle ${id}`);
                alert("Failed to toggle device");
            }
        }

        // --- Developer Mode Logic ---
        function toggleDevMode() {
            isDevMode = !isDevMode;
            // Toggle UI State
            const btn = document.getElementById('devToggleKnob');
            if (isDevMode) {
                btn.classList.add('translate-x-6', 'bg-cyan-500');
                btn.classList.remove('translate-x-1');
                document.getElementById('devConsole').classList.remove('hidden');
                setTimeout(() => document.getElementById('devConsole').classList.remove('translate-x-full', 'translate-y-full'), 50);

                log("Dev Mode ENABLED");
            } else {
                btn.classList.remove('translate-x-6', 'bg-cyan-500');
                btn.classList.add('translate-x-1');
                document.getElementById('devConsole').classList.add('translate-y-full');
                setTimeout(() => document.getElementById('devConsole').classList.add('hidden'), 300);

                log("Dev Mode DISABLED");
            }
            // Rerender to show/hide debug overlays
            loadDevices();
        }

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            const logLine = `[${time}] ${msg}`;
            systemLogs.push(logLine);
            if (systemLogs.length > 50) systemLogs.shift();

            const container = document.getElementById('sysLogs');
            const p = document.createElement('p');
            p.textContent = logLine;
            container.appendChild(p);
            // Auto scroll
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        function handleConsoleCmd(e) {
            if (e.key === 'Enter') {
                const cmd = e.target.value;
                log("> " + cmd);
                e.target.value = '';
                // Sim exec
                setTimeout(() => {
                    if (cmd === 'help') log("Available: help, clear, status");
                    else if (cmd === 'status') log("System OK. Load: 24%");
                    else if (cmd === 'clear') {
                        document.getElementById('sysLogs').innerHTML = '';
                    } else {
                        log("Unknown command: " + cmd);
                    }
                }, 100);
            }
        }

        function showJson(data) {
            document.getElementById('jsonViewer').textContent = JSON.stringify(data, null, 2);
            log("Inspecting Device: " + data.name);
        }

        function renderDevices(devices) {
            const container = document.getElementById('deviceList');
            container.innerHTML = '';

            devices.forEach(device => {
                const iconPath = icons[device.type] || icons.OTHER;

                const card = document.createElement('div');
                card.className = "relative flex items-center justify-between bg-gray-900/50 p-4 rounded-lg hover:bg-gray-700/50 transition-colors duration-200 mb-4 overflow-hidden";

                // Debug Overlay
                let debugOverlay = '';
                if (isDevMode) {
                    debugOverlay = `<div class='absolute inset-0 bg-black/80 flex items-center justify-center text-xs font-mono text-green-400 z-10 cursor-pointer' onclick='showJson(${JSON.stringify(device)})'>
                        JSON VIEW (ID: ${device.id})
                    </div>`;
                }

                card.innerHTML = `
                  ${debugOverlay}  
                  <div class="flex items-center space-x-4">
                    <div class="${device.status ? 'text-cyan-400' : 'text-gray-500'}">
                      <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="${iconPath}"></path>
                      </svg>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-100">${device.name}</p>
                      <p class="text-xs text-gray-400">
                        ${device.type}
                        ${device.status ? '<span class="text-green-400 ml-2">' + device.powerRating + 'W</span>' : '<span class="text-gray-500 ml-2">Off</span>'}
                      </p>
                    </div>
                  </div>
                  <button
                    onclick="toggleDevice(${device.id})"
                    type="button"
                    role="switch"
                    aria-checked="${device.status}"
                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 focus:ring-offset-gray-800 ${device.status ? 'bg-cyan-600' : 'bg-gray-600'}">
                    <span
                      aria-hidden="true"
                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${device.status ? 'translate-x-5' : 'translate-x-0'}"></span>
                  </button>
                `;
                container.appendChild(card);
            });
        }

        function updateActiveCount(devices) {
            const active = devices.filter(d => d.status).length;
            document.getElementById('activeDevices').textContent = `${active} / ${devices.length}`;
        }

        function updateRecommendation(usage) {
            const elem = document.getElementById('recommendationText');
            if (usage > 50) {
                elem.textContent = "High usage detected. Consider reducing AC usage or switching to Eco mode.";
            } else {
                elem.textContent = "Usage is within optimal limits. Great job!";
            }
        }

        // --- Chart Logic ---
        function updateChart(newValue) {
            energyHistory.push(newValue);
            if (energyHistory.length > maxHistoryPoints) energyHistory.shift();

            if (energyHistory.length < 2) return;

            // Calculate path
            // Map 0..maxHistoryPoints to 0..300 (x)
            // Map min..max Value to 100..0 (y)

            const width = 300;
            const height = 100;
            const maxVal = Math.max(...energyHistory) * 1.2 || 1;
            const minVal = 0;

            let d = `M 0,${height} `; // Start bottom left

            // Generate points
            const points = energyHistory.map((val, i) => {
                const x = (i / (maxHistoryPoints - 1)) * width;
                const y = height - ((val - minVal) / (maxVal - minVal)) * height;
                return `${x},${y}`;
            });

            // Construct line path
            const linePathCmd = "M " + points.join(" L ");
            document.getElementById('linePath').setAttribute('d', linePathCmd);

            // Construct area path
            const areaPathCmd = linePathCmd + ` L ${width},${height} L 0,${height} Z`;
            document.getElementById('areaPath').setAttribute('d', areaPathCmd);
        }

    </script>
</body>

</html>