<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>My Home</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Dev Console Styles */
        #devConsole {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 300px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            z-index: 9999;
            display: none;
            flex-direction: column;
            border-top: 2px solid #333;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
        }

        #devConsole.active {
            display: flex;
        }

        .console-header {
            background: #333;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
        }

        .console-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .console-logs {
            flex: 2;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #333;
            font-size: 12px;
        }

        .console-sidebar {
            flex: 1;
            background: #252526;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        .log-time {
            color: #888;
            margin-right: 8px;
        }

        .debug-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 255, 0, 0.1);
            border: 2px dashed #00ff00;
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        .debug-overlay.active {
            display: block;
        }

        .debug-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #00ff00;
            color: black;
            font-size: 10px;
            padding: 2px 4px;
            font-weight: bold;
        }

        .dev-toggle-container {
            display: flex;
            align-items: center;
            margin-left: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
            margin-left: 8px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2196F3;
        }

        input:checked+.slider:before {
            transform: translateX(14px);
        }

        .priority-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: white;
        }

        .priority-HIGH {
            background-color: #FF3B30;
        }

        .priority-MEDIUM {
            background-color: #FF9500;
        }

        .priority-LOW {
            background-color: #34C759;
        }
    </style>
</head>

<body class="">
    <!-- Wrapper for Centered Content -->
    <div class="main-content-wrapper">
        <div class="header">
            <h1>My Home</h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- Load & Progress Bar -->
                <div style="flex: 1; margin: 0 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666; margin-bottom: 4px;">
                        <span>Load: <b id="currentLoad">0</b>W / <b id="maxLoad"
                                th:text="${maxWattage}">3000</b>W</span>
                        <span th:if="${!userRole.contains('GUEST')}" onclick="editMaxWattage()"
                            style="color: #007AFF; cursor: pointer; font-weight: 600;">Edit</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #E5E5EA; border-radius: 4px; overflow: hidden;">
                        <div id="loadBar"
                            style="width: 0%; height: 100%; background: #34C759; transition: width 0.3s, background 0.3s;">
                        </div>
                    </div>
                </div>

                <!-- Admin Dev Mode Toggle -->
                <div th:if="${userRole != null and userRole.contains('ADMIN')}" class="dev-toggle-container">
                    <span style="font-size: 12px; font-weight: 600; color: #333;">DEV MODE</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="devModeToggle" onchange="toggleDevMode()">
                        <span class="slider"></span>
                    </label>
                </div>

                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit"
                        style="background: white; color: #FF3B30; padding: 6px 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 12px;">Logout</button>
                </form>
            </div>
        </div>

        <!-- Devices Header & Add Button (Hidden for GUEST) -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 16px;">
            <h3 style="font-size: 20px; margin: 0;">Devices</h3>
            <button th:if="${!userRole.contains('GUEST')}" onclick="openModal()"
                style="background: #007AFF; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer;">+
                Add</button>
        </div>

        <div class="device-scroll-wrapper">
            <div class="grid-container" id="deviceGrid">
                <!-- Devices rendered via JS -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Dock -->
    <div class="dock-container">
        <a href="/home" class="dock-item active">
            <svg class="dock-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
            </svg>
            <span class="dock-label">Home</span>
        </a>

        <!-- Usage Link (Hidden for GUEST) -->
        <a th:if="${!userRole.contains('GUEST')}" href="/usage" class="dock-item">
            <svg class="dock-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M16 6L18.29 8.29L13.41 13.17L9.41 9.17L2 16.59L3.41 18L9.41 12L13.41 16L19.71 9.71L22 12V6H16Z" />
            </svg>
            <span class="dock-label">Usage</span>
        </a>

        <!-- Settings Link -->
        <a href="/settings" class="dock-item">
            <svg class="dock-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
            </svg>
            <span class="dock-label">Settings</span>
        </a>
    </div>

    <!-- Theme Init -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        })();
    </script>

    <!-- Add Device Modal (Wizard) -->
    <div id="addDeviceModal"
        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 24px; border-radius: 20px; width: 340px; text-align: center;">
            <h2 id="wizardTitle" style="margin-bottom: 8px;">Add Device</h2>
            <p id="wizardSub" style="color: #8E8E93; font-size: 14px; margin-bottom: 24px;">Searching for nearby
                devices...</p>

            <div id="wizardContent" class="wizard-content">
                <!-- Dynamic Content Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Developer Console Panel -->
    <div id="devConsole">
        <div class="console-header">
            <span>DEVELOPER CONSOLE [ADMIN ACCESS]</span>
            <div style="display: flex; gap: 10px;">
                <input type="text" placeholder="exec command..."
                    style="background: #000; border: 1px solid #444; color: #00ff00; padding: 2px 5px;"
                    onkeypress="handleConsoleCmd(event)">
                <span style="cursor: pointer;" onclick="toggleDevMode()">[X]</span>
            </div>
        </div>
        <div class="console-body">
            <div class="console-logs" id="sysLogs">
                <div class="log-entry"><span class="log-time">SYSTEM</span> Console Initialized...</div>
            </div>
            <div class="console-sidebar" id="jsonViewer">
                <div style="color: #666; text-align: center; margin-top: 20px;">select object to inspect</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        // Inject User Role
        const userRole = /*[[${userRole}]]*/ 'ROLE_USER';
        const isGuest = userRole.includes("GUEST");
        console.log("Current User Role:", userRole, "Is Guest:", isGuest);

        // Hide Dev Mode for everyone initially (Thymeleaf already handled visibility of toggle)



        let isDevMode = false;
        let systemLogs = [];

        function toggleDevMode() {
            const toggle = document.getElementById('devModeToggle');
            isDevMode = toggle ? toggle.checked : false;

            const consoleDiv = document.getElementById('devConsole');
            if (isDevMode) {
                consoleDiv.classList.add('active');
                log("Dev Mode ENABLED. Debug overlays active.");
            } else {
                consoleDiv.classList.remove('active');
                log("Dev Mode DISABLED.");
            }
            renderDevices(currentDevices);
        }

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('sysLogs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${time}</span> ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function handleConsoleCmd(e) {
            if (e.key === 'Enter') {
                const rawCmd = e.target.value.trim();
                log("> " + rawCmd);

                const parts = rawCmd.split(' ');
                const cmd = parts[0];
                const arg = parts[1];

                if (cmd === 'clear') document.getElementById('sysLogs').innerHTML = '';
                else if (cmd === 'help') log("Available: clear, status, inspect <id>");
                else if (cmd === 'status') log("System Clean. Active Connections: 1");
                else if (cmd === 'inspect') {
                    if (arg) {
                        const dev = currentDevices.find(d => d.id == arg);
                        if (dev) {
                            showJson(dev);
                            log(`Inspected Device ${arg}`);
                        } else {
                            log(`Device ${arg} not found.`);
                        }
                    } else {
                        log("Usage: inspect <id>");
                    }
                }
                else log("Unknown command.");
                e.target.value = '';
            }
        }

        function showJson(data) {
            document.getElementById('jsonViewer').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }

        // Server-side init with fallback for clean JS linting
        let maxWattage = /*[[${maxWattage}]]*/ 3000;

        async function editMaxWattage() {
            const newVal = prompt("Set new Max Wattage (Watts):", maxWattage);
            if (newVal && !isNaN(newVal)) {
                const newMax = parseFloat(newVal);
                try {
                    const res = await fetch('/api/user/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ maxWattage: newMax })
                    });
                    if (res.ok) {
                        maxWattage = newMax;
                        document.getElementById('maxLoad').innerText = maxWattage;
                        fetchDevices(); // Re-render bar
                        alert("Max Wattage Updated!");
                    } else {
                        alert("Failed to update settings.");
                    }
                } catch (e) {
                    alert("Error updating settings");
                }
            }
        }

        // Standard App Logic
        let currentDevices = [];

        async function fetchDevices() {
            const res = await fetch('/api/devices');
            if (res.ok) {
                const devices = await res.json();
                currentDevices = devices;

                // Calc Load
                const currentLoad = devices.filter(d => d.status).reduce((acc, d) => acc + d.powerRating, 0);
                document.getElementById('currentLoad').innerText = currentLoad;

                // Update Progress Bar
                // Ensure maxWattage is valid
                const max = (typeof maxWattage !== 'undefined' && maxWattage) ? maxWattage : 3000;
                const percentage = Math.min((currentLoad / max) * 100, 100);
                const bar = document.getElementById('loadBar');
                if (bar) {
                    bar.style.width = percentage + '%';

                    // Color Code
                    if (percentage < 70) bar.style.background = '#34C759'; // Green
                    else if (percentage < 90) bar.style.background = '#FF9500'; // Orange
                    else bar.style.background = '#FF3B30'; // Red
                }

                renderDevices(devices);
            }
        }

        function renderDevices(devices) {
            const grid = document.getElementById('deviceGrid');
            grid.innerHTML = '';

            devices.forEach(device => {
                const isAc = device.type === 'AC';
                const isLight = device.type === 'LIGHT';
                const icon = isAc ?
                    `<path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6V12L16,16L17.41,14.59L14,11V6H12Z" />` :
                    (isLight ? `<path d="M12,2A7,7 0 0,0 5,9C5,12.86 8,15.64 8,19A2,2 0 0,0 10,21H14A2,2 0 0,0 16,19C16,15.64 19,12.86 19,9A7,7 0 0,0 12,2M12,4A5,5 0 0,1 17,9C17,11.5 15,13.75 14.5,16H9.5C9,13.75 7,11.5 7,9A5,5 0 0,1 12,4M9,22H15V23H9V22Z" />` :
                        `<path d="M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3M5,5V19H19V5H5Z" />`);

                const debugHtml = isDevMode ? `
                    <div class="debug-overlay active" onclick="event.stopPropagation(); showJson(currentDevices.find(d => d.id === ${device.id})); log('Inspected Device ${device.id}');">
                        <div class="debug-label">ID: ${device.id} (RAW)</div>
                    </div>` : '';

                // GUEST Check: If Guest, no delete button, no click toggle
                const deleteBtn = !isGuest ?
                    `<div style="position: absolute; top: 10px; right: 10px; color: #FF3B30; cursor: pointer; padding: 5px; z-index: 5;" onclick="deleteDevice(event, ${device.id})">âœ•</div>`
                    : '';

                // Toggle Switch HTML
                const toggleSwitch = !isGuest ? `
                    <label class="toggle-switch" onclick="event.stopPropagation()" style="margin-top: auto;">
                        <input type="checkbox" ${device.status ? 'checked' : ''} onchange="toggleDevice(${device.id})">
                        <span class="slider"></span>
                    </label>
                ` : `<p class="${device.status ? 'status-on' : 'status-off'}" style="margin-top: auto;">${device.status ? 'On' : 'Off'}</p>`;

                const priorityBadge = device.priority ? `<div class="priority-badge priority-${device.priority}">${device.priority}</div>` : '';

                const card = document.createElement('div');
                card.className = 'card';
                card.style = `position: relative; cursor: default;`; // Removed pointer cursor since click is gone
                card.innerHTML = `
                        ${debugHtml}
                        ${deleteBtn}
                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: flex-start;">
                            <div class="icon-container ${device.status ? 'on' : 'off'}" style="margin-bottom: 12px;">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">${icon}</svg>
                            </div>
                            <h3 style="margin-bottom: 8px;">${device.name}</h3>
                            ${toggleSwitch}
                            ${priorityBadge}
                        </div>
                     `;
                grid.appendChild(card);
            });
        }

        async function toggleDevice(id) {
            if (isGuest) return; // Client-side guard
            log(`Toggling Device ${id}`);
            try {
                const res = await fetch('/api/devices/' + id + '/status', { method: 'PUT' });
                if (!res.ok) {
                    const errMsg = await res.text();
                    alert(errMsg || 'Cannot turn ON: Max Wattage Exceeded');
                }
            } catch (e) {
                console.error(e);
            }
            fetchDevices(); // Refresh logic handles state update
        }

        async function deleteDevice(event, id) {
            if (isGuest) return; // Client-side guard
            event.stopPropagation();
            if (!confirm('Delete this device?')) return;
            log(`Deleting Device ${id}`);
            await fetch('/api/devices/' + id, {
                method: 'DELETE'
            });
            fetchDevices();
        }

        // Modal functions
        function openModal() {
            document.getElementById('addDeviceModal').style.display = 'flex';
            switchTab('manual');
        }

        function closeModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (tab === 'manual') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('manualTab').style.display = 'block';
                document.getElementById('pairTab').style.display = 'none';
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('manualTab').style.display = 'none';
                document.getElementById('pairTab').style.display = 'block';
                document.getElementById('scanBox').style.display = 'flex';
                document.getElementById('pairCode').style.display = 'none';
                document.getElementById('scanText').innerText = "Looking for devices...";
                document.getElementById('pairBtn').innerText = "Enter Code";
                document.getElementById('pairBtn').onclick = startPairing;
            }
        }

        function startPairing() {
            document.getElementById('scanBox').style.display = 'none';
            document.getElementById('pairCode').style.display = 'block';
            document.getElementById('scanText').innerText = "Enter the setup code found on your device.";
            const btn = document.getElementById('pairBtn');
            btn.innerText = "Connect";
            btn.onclick = async () => await addDevice('pair');
        }

        // --- Wizard Logic ---
        let wizardState = 'QR_ENTRY'; // QR_ENTRY, PROCESSING, FOUND, MANUAL
        let foundDeviceMock = null;

        function openModal() {
            const modal = document.getElementById('addDeviceModal');
            modal.style.display = 'flex';
            setWizardState('QR_ENTRY');
        }

        function closeModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
        }

        function triggerUpload() {
            document.getElementById('qrInput').click();
        }

        function handleFile(input) {
            if (input.files && input.files[0]) {
                setWizardState('PROCESSING');
                // Simulate processing time
                setTimeout(() => {
                    foundDeviceMock = { name: "Samsung Smart Fridge", type: "FRIDGE", priority: "HIGH" };
                    setWizardState('FOUND');
                }, 2000);
            }
        }

        function submitCode() {
            const code = document.getElementById('setupCode').value;
            if (code && code.length >= 4) {
                setWizardState('PROCESSING');
                setTimeout(() => {
                    foundDeviceMock = { name: "Living Room AC", type: "AC", priority: "MEDIUM" };
                    setWizardState('FOUND');
                }, 1500);
            } else {
                alert("Please enter a valid code");
            }
        }

        function setWizardState(state) {
            wizardState = state;
            const content = document.getElementById('wizardContent');
            const title = document.getElementById('wizardTitle');
            const sub = document.getElementById('wizardSub');

            if (state === 'QR_ENTRY') {
                title.innerText = "Add Device";
                sub.innerText = "Scan a QR code or enter setup code.";
                content.innerHTML = `
                    <input type="file" id="qrInput" hidden accept="image/*" onchange="handleFile(this)">
                    
                    <div class="qr-upload-box" onclick="triggerUpload()">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="#007AFF" style="margin-bottom: 8px;">
                            <path d="M4,4H10V10H4V4M20,4V10H14V4H20M14,14H20V20H14V14M4,14H10V20H4V14M2,2V12H12V2H2M14,2V12H22V2H14M2,14V24H12V14H2M14,14V24H22V14H14Z" />
                        </svg>
                        <span style="font-weight: 600; color: #007AFF;">Upload QR Code</span>
                    </div>

                    <div class="or-divider">OR</div>

                    <div style="width: 100%; display: flex; gap: 8px;">
                        <input type="text" id="setupCode" placeholder="Enter Setup Code" class="input-field" style="margin-bottom: 0; flex: 2; height: 44px; padding: 0 12px;">
                        <button onclick="submitCode()" style="flex: 1; background: #007AFF; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">Connect</button>
                    </div>

                    <div style="margin-top: 16px; font-size: 14px; color: #8E8E93; cursor: pointer;" onclick="closeModal()">
                        Cancel
                    </div>
                `;

            } else if (state === 'PROCESSING') {
                title.innerText = "Verifying...";
                sub.innerText = "Connecting to device...";
                content.innerHTML = `
                    <div style="position: relative; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; margin: 40px auto;">
                        <div class="pulse-ring"></div>
                        <div class="pulse-ring" style="animation-delay: 0.5s;"></div>
                    </div>
                `;

            } else if (state === 'FOUND') {
                title.innerText = "Device Found";
                sub.innerText = "We found a new device!";
                content.innerHTML = `
                    <div class="found-device-item">
                        <div style="background: white; padding: 8px; border-radius: 50%;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="#34C759"><path d="M12,2A7,7 0 0,1 19,9C19,11.38 17.81,13.47 16,14.74V17A1,1 0 0,1 15,18H9A1,1 0 0,1 8,17V14.74C6.19,13.47 5,11.38 5,9A7,7 0 0,1 12,2M9,21V20H15V21A1,1 0 0,1 14,22H10A1,1 0 0,1 9,21Z" /></svg>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: 600;">${foundDeviceMock.name}</div>
                            <div style="font-size: 12px; color: #8E8E93;">Type: ${foundDeviceMock.type}</div>
                        </div>
                    </div>
                    <button onclick="addDevice('auto')" style="width: 100%; padding: 14px; background: #007AFF; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">Add Name & Finish</button>
                `;

            }
        }

        async function addDevice(mode) {
            let deviceData = {};

            if (mode === 'auto') {
                deviceData = {
                    name: foundDeviceMock.name,
                    type: foundDeviceMock.type,
                    powerRating: 150.0,
                    status: false,
                    priority: foundDeviceMock.priority || 'LOW'
                };
            } else {
                const name = document.getElementById('devName').value;
                const type = document.getElementById('devType').value;
                const power = document.getElementById('devPower').value;
                const priority = document.getElementById('devPriority').value;

                if (!name || !power) {
                    alert('Please fill all fields');
                    return;
                }

                deviceData = {
                    name: name,
                    type: type,
                    powerRating: parseFloat(power),
                    status: false,
                    priority: priority
                };
            }

            const res = await fetch('/api/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(deviceData)
            });

            if (res.ok) {
                closeModal();
                fetchDevices();
                alert("Device Added Successfully!");
            } else {
                alert('Failed to add device');
            }
        }

        window.onload = () => {
            // No Energy Data Fetching here - handled in Usage page
            fetchDevices();
            log("Application Loaded.");
        };
    </script>
</body>

</html>